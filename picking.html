<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ayuda Picking</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{ --bg:#0b0e14; --card:#111520; --muted:#97a3b6; --text:#e6edf6; --accent:#4f46e5; --ok:#16a34a; --err:#ef4444; --border:#1c2233; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fb; --card:#fff; --muted:#64748b; --text:#0f172a; --accent:#4f46e5; --ok:#16a34a; --err:#dc2626; --border:#e5e7eb; --shadow:0 10px 30px rgba(2,6,23,.08) }
  }
  *{ box-sizing:border-box } body{ margin:0; padding:24px; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text) }
  .wrap{ max-width:1100px; margin:0 auto; display:grid; gap:16px }
  .card{ border:1px solid var(--border); border-radius:var(--radius); background:var(--card); padding:18px; box-shadow:var(--shadow) }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
  .title{ margin:0 0 10px; font-size:22px; font-weight:800 }
  .muted{ color:var(--muted) } .ok{ color:var(--ok) } .err{ color:var(--err) }
  .input, select{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text) }
  .btn{ padding:10px 14px; border-radius:10px; border:1px solid transparent; background:var(--accent); color:#fff; font-weight:700; cursor:pointer }
  .btn-ghost{ padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text) }
  .hero-img{ width:100%; max-height:320px; object-fit:contain; border:1px solid var(--border); border-radius:12px; background:#0b0f19 }
  .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:16px } @media (max-width:900px){ .grid{ grid-template-columns:1fr } }
  .badge{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid var(--border); border-radius:999px; }
  .progress{ display:flex; gap:8px; flex-wrap:wrap }
  .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px }
  .chip.ok{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.35) }
  .chip.pending{ background: transparent }
</style>
</head>
<body>
<div class="wrap">

  <!-- Selección inicial -->
  <section class="card">
    <h2 class="title">Seleccioná trabajo</h2>
    <div class="row">
      <label>Línea</label>
      <select id="linea"></select>

      <label><input type="radio" name="modo" value="fecha" checked> Por fecha</label>
      <input id="fecha" class="input" type="date">

      <label><input type="radio" name="modo" value="wo"> Por WO</label>
      <input id="wo" class="input" type="text" placeholder="WO1234" disabled>

      <button id="cargar" class="btn">Cargar</button>
      <span id="selStatus" class="muted"></span>
    </div>
  </section>

  <!-- Contenido principal -->
  <section class="grid" id="content" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2 class="title" id="skuTitle">Código</h2>
        <span class="badge" id="woBadge">WO: —</span>
      </div>
      <div class="row"><b style="min-width:160px;color:var(--muted)">Descripción:</b> <span id="desc"></span></div>
      <div class="row"><b style="min-width:160px;color:var(--muted)">Ubicación:</b> <span id="ubic"></span></div>
      <div class="row">
        <b style="min-width:160px;color:var(--muted)">Requerida:</b> <span id="req"></span>
        <b style="min-width:160px;color:var(--muted)">Restante:</b> <span id="rest" class="badge">—</span>
      </div>
      <div style="margin-top:8px" id="imgWrap" class="muted">Cargando imagen…</div>

      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">

      <div class="row">
        <b style="min-width:160px;color:var(--muted)">Escanear bobina</b>
        <input id="scan" class="input" type="text" placeholder="ID_FILA (QR)" />
        <button id="validar" class="btn">Validar</button>
        <button id="cam" class="btn btn-ghost">Usar cámara</button>
        <span id="scanStatus" class="muted"></span>
      </div>

      <div id="cameraWrap" class="card" style="display:none; padding:12px; margin-top:8px">
        <div id="qr-reader" style="width:100%"></div>
        <div class="muted" style="margin-top:6px">Apuntá el QR. Al leerlo, se completará el campo y se validará automáticamente.</div>
      </div>

      <div id="takeWrap" style="display:none; margin-top:10px">
        <div class="row">
          <b style="min-width:160px;color:var(--muted)">Cantidad a tomar</b>
          <input id="takeQty" class="input" type="number" min="0" step="1">
          <button id="confirmar" class="btn">Confirmar</button>
          <button id="cancel" class="btn btn-ghost">Cancelar</button>
          <span id="takeStatus" class="muted"></span>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="row" style="justify-content:flex-end; gap:8px">
          <button id="prev" class="btn btn-ghost">Anterior</button>
          <button id="skip" class="btn btn-ghost">Saltar</button>
          <button id="next" class="btn">Siguiente</button>
        </div>
      </div>
    </div>

    <aside class="card">
      <h2 class="title">Progreso</h2>
      <div class="row"><span id="progText" class="muted">0 / 0</span></div>
      <div id="chips" class="progress"></div>
    </aside>
  </section>

  <div id="status" class="muted">Listo para cargar.</div>
</div>

<!-- Scanner de QR por cámara -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
  // === Helpers y estado ===
  const DEFAULT_LINES = ['L0','L1','L2','TM'];

  function normalizeSharePointImageUrl(u) {
    if (!u) return u;
    u = u.replace(/%2520/g, '%20');
    try {
      const url = new URL(u);
      if (url.pathname.startsWith('/:u:/') || url.pathname.startsWith('/:i:/') || url.pathname.startsWith('/:x:/')) {
        if (!url.searchParams.has('download')) url.searchParams.set('download','1');
        return url.toString();
      }
      if (url.pathname.includes('/Forms/AllItems.aspx')) {
        const idParam = url.searchParams.get('id');
        if (idParam) {
          const decoded = decodeURIComponent(idParam);
          const base = url.origin + '/sites/ALMACENPRE-PRODUCCION/_layouts/15/download.aspx?SourceUrl=';
          return base + encodeURIComponent(decoded);
        }
      }
      return u;
    } catch { return u; }
  }

  let LIST = [];   // Ítems de picking (GET_PICKING)
  let BASE = {};   // Maestro por código (GET_BASE_ETIQUETAS)
  let idx = 0;     // Índice del ítem actual
  let restos = {}; // Mapa CODIGO@WO -> restante

  // === Referencias UI ===
  const lineaSel = document.getElementById('linea');
  const fechaInp = document.getElementById('fecha');
  const woInp = document.getElementById('wo');
  const selStatus = document.getElementById('selStatus');
  const statusEl = document.getElementById('status');
  const content = document.getElementById('content');

  const skuTitle = document.getElementById('skuTitle');
  const woBadge  = document.getElementById('woBadge');
  const descEl   = document.getElementById('desc');
  const ubicEl   = document.getElementById('ubic');
  const reqEl    = document.getElementById('req');
  const restEl   = document.getElementById('rest');
  const imgWrap  = document.getElementById('imgWrap');

  const scanInp  = document.getElementById('scan');
  const validarBtn = document.getElementById('validar');
  const scanStatus = document.getElementById('scanStatus');
  const camBtn = document.getElementById('cam');
  const cameraWrap = document.getElementById('cameraWrap');

  const takeWrap = document.getElementById('takeWrap');
  const takeQty  = document.getElementById('takeQty');
  const confirmarBtn = document.getElementById('confirmar');
  const cancelBtn = document.getElementById('cancel');
  const takeStatus = document.getElementById('takeStatus');

  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const skipBtn = document.getElementById('skip');

  const chips = document.getElementById('chips');
  const progText = document.getElementById('progText');

  // === Modo: por fecha o por WO ===
  document.querySelectorAll('input[name="modo"]').forEach(r => {
    r.addEventListener('change', () => {
      const byFecha = r.value === 'fecha';
      fechaInp.disabled = !byFecha;
      woInp.disabled = byFecha;
    });
  });
  // Fecha default hoy
  fechaInp.value = new Date().toISOString().slice(0,10);

  // === Poblar líneas con fallback ===
  async function loadLines() {
    try {
      const r = await fetch('/api/picking/lines?_ts='+Date.now(), { cache:'no-store' });
      const arr = await r.json();
      renderLines(Array.isArray(arr) && arr.length ? arr : DEFAULT_LINES);
    } catch { renderLines(DEFAULT_LINES); }
  }
  function renderLines(arr) {
    lineaSel.innerHTML = '';
    arr.forEach(v => {
      const opt = document.createElement('option'); opt.value = v; opt.textContent = v;
      lineaSel.appendChild(opt);
    });
  }

  // === Base etiquetas (una vez por sesión) ===
  async function loadBase() {
    const r = await fetch('/api/base/etiquetas?_ts='+Date.now(), { cache:'no-store' });
    const data = await r.json();
    BASE = {};
    if (Array.isArray(data)) {
      data.forEach(x => {
        const cod = x?.CODIGO || x?.Código || x?.codigo;
        if (cod) BASE[String(cod)] = {
          DESCRIPCION: x?.DESCRIPCION ?? x?.DESCRIPCIÓN ?? '',
          UBICACION_ALMACEN: x?.UBICACION_ALMACEN ?? x?.['UBICACION ALMACEN'] ?? x?.['UBICACIÓN'] ?? '',
          IMAGEN_URL: x?.IMAGEN_URL ?? ''
        };
      });
    }
  }

  // === Helpers de render ===
  function keyOf(item) { return `${item.CODIGO}@@${item.WO}`; }

  function renderProgress() {
    chips.innerHTML = '';
    const total = LIST.length;
    let okCount = 0;
    LIST.forEach((it, i) => {
      const key = keyOf(it);
      const rem = restos[key];
      const chip = document.createElement('div');
      chip.className = 'chip ' + (rem <= 0 ? 'ok' : 'pending');
      chip.textContent = `${it.CODIGO} (${rem <= 0 ? 'OK' : `rest ${rem}`})`;
      chip.title = `WO ${it.WO} • ORDEN ${it.ORDEN}`;
      chip.addEventListener('click', () => { idx = i; renderItem(); });
      chips.appendChild(chip);
      if (rem <= 0) okCount++;
    });
    progText.textContent = `${okCount} / ${total}`;
  }

  function renderItem() {
    if (!LIST.length) return;
    const it = LIST[idx];
    const base = BASE[it.CODIGO] || {};
    const key = keyOf(it);
    const restante = restos[key];

    skuTitle.textContent = it.CODIGO;
    woBadge.textContent = `WO: ${it.WO}`;
    // Aviso visual si cambió la WO respecto al ítem anterior
    if (idx > 0) {
      const prevWO = LIST[idx-1]?.WO;
      if (prevWO && prevWO !== it.WO) {
        woBadge.style.border = '1px solid var(--accent)';
        woBadge.style.boxShadow = '0 0 0 3px rgba(79,70,229,.25)';
        setTimeout(() => { woBadge.style.border='1px solid var(--border)'; woBadge.style.boxShadow='none'; }, 900);
      }
    }

    descEl.textContent = base.DESCRIPCION || it.DESCRIPCION || '—';
    ubicEl.textContent = base.UBICACION_ALMACEN || it.UBICACION_ALMACEN || '—';
    reqEl.textContent = String(it.CANTIDAD);

    // Mostrar restante con excedente
    let restText = '';
    if (restante >= 0) restText = String(restante);
    else restText = `0 (excedente ${Math.abs(restante)})`;
    restEl.textContent = restText;

    // Imagen
    const raw = base.IMAGEN_URL || it.IMAGEN_URL;
    if (raw) {
      const u = normalizeSharePointImageUrl(raw);
      imgWrap.innerHTML = `<img src="${u}" class="hero-img" loading="lazy" alt="Etiqueta">
        <div style="margin-top:6px"><a href="${u}" target="_blank" rel="noreferrer">Abrir imagen</a></div>`;
    } else {
      imgWrap.innerHTML = '<span class="muted">Sin imagen</span>';
    }

    prevBtn.disabled = (idx === 0);
    nextBtn.disabled = (idx >= LIST.length - 1);
    scanInp.value = ''; scanStatus.textContent = '';
    takeWrap.style.display = 'none'; takeStatus.textContent = '';
    scanInp.focus();

    renderProgress();
  }

  // === Carga del picking ===
  async function loadPicking({ fecha, wo, linea }) {
    selStatus.textContent = 'Cargando…';
    const qs = new URLSearchParams();
    if (fecha) qs.set('fecha', fecha);
    if (wo) qs.set('wo', wo);
    if (linea) qs.set('linea', linea);
    qs.set('v', Date.now());
    const r = await fetch(`/api/picking/list?${qs}`, { cache:'no-store' });
    const arr = await r.json();
    if (!Array.isArray(arr) || !arr.length) { selStatus.textContent = 'Sin resultados'; return false; }

    LIST = arr.map(x => ({
      ORDEN: Number(x.ORDEN ?? 0),
      WO: String(x.WO ?? ''),
      LINEA: String(x.LINEA ?? ''),
      CODIGO: String(x.CODIGO ?? x['CÓDIGO'] ?? ''),
      DESCRIPCION: x.DESCRIPCION ?? x['DESCRIPCIÓN'] ?? '',
      CANTIDAD: Number(x.CANTIDAD ?? 0),
      UBICACION_ALMACEN: x.UBICACION_ALMACEN ?? x['UBICACION ALMACEN'] ?? x['UBICACIÓN'] ?? '',
      IMAGEN_URL: x.IMAGEN_URL ?? ''
    })).filter(x => x.CODIGO && x.CANTIDAD > 0);

    LIST.sort((a,b) => (a.ORDEN - b.ORDEN) || (a.WO > b.WO ? 1 : -1));

    restos = {};
    LIST.forEach(it => restos[keyOf(it)] = it.CANTIDAD);

    idx = 0;
    selStatus.textContent = '';
    statusEl.style.display = 'none';
    content.style.display = 'grid';
    renderItem();
    return true;
  }

  // === Eventos UI ===
  document.querySelectorAll('input[name="modo"]').forEach(r => {
    r.addEventListener('change', () => {
      if (r.checked && r.value === 'wo') { woInp.disabled = false; fechaInp.disabled = true; }
      if (r.checked && r.value === 'fecha') { woInp.disabled = true; fechaInp.disabled = false; }
    });
  });

  document.getElementById('cargar').addEventListener('click', async () => {
    const linea = lineaSel.value || '';
    const modo = document.querySelector('input[name="modo"]:checked').value;
    const fecha = (modo === 'fecha') ? fechaInp.value : null;
    const wo = (modo === 'wo') ? (woInp.value || '').trim() : null;
    if (modo === 'fecha' && !fecha) { selStatus.textContent = 'Elegí una fecha'; return; }
    if (modo === 'wo' && !wo) { selStatus.textContent = 'Ingresá una WO'; return; }
    await loadBase();
    await loadPicking({ fecha, wo, linea });
  });

  // Enter en input de escaneo = Validar
  scanInp.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); validarBtn.click(); }
  });

  // Validar bobina (con loading)
  validarBtn.addEventListener('click', async () => {
    const it = LIST[idx]; if (!it) return;
    const key = keyOf(it);
    const restante = restos[key];
    const id = scanInp.value.trim();

    scanStatus.textContent = '';
    takeWrap.style.display = 'none';
    takeStatus.textContent = '';

    if (!id) { scanStatus.textContent = 'Ingresá/escaneá un ID_FILA'; return; }

    validarBtn.disabled = true;
    validarBtn.dataset.label = validarBtn.textContent;
    validarBtn.textContent = 'Validando…';
    scanStatus.textContent = 'Validando…';

    try {
      const r = await fetch(`/api/bobina/${encodeURIComponent(id)}?v=${Date.now()}`, { cache:'no-store' });
      const d = await r.json();
      const cod = d?.CODIGO ?? d?.['CÓDIGO'];
      // guardo disponible bobina en un atributo del botón para usar luego
      validarBtn.dataset.cantBobina = String(Number(d?.CANTIDAD ?? 0));

      if (!cod) { scanStatus.innerHTML = '<span class="err">No se pudo leer el código de la bobina.</span>'; return; }
      if (String(cod) !== String(it.CODIGO)) {
        scanStatus.innerHTML = `<span class="err">La bobina (${cod}) no coincide con el SKU actual (${it.CODIGO}).</span>`;
        return;
      }

      const cantBobina = Number(validarBtn.dataset.cantBobina || 0);
      const propuesta = Math.max(0, Math.min(cantBobina, Math.max(0, restante)));
      takeQty.value = propuesta;
      takeWrap.style.display = 'block';
      takeStatus.textContent = `Bobina OK. Disponible: ${cantBobina}. Restante del SKU: ${restante}.`;
      takeQty.focus(); takeQty.select();
    } catch (e) {
      scanStatus.innerHTML = `<span class="err">${e?.message || 'Error al consultar bobina'}</span>`;
    } finally {
      validarBtn.disabled = false;
      validarBtn.textContent = validarBtn.dataset.label || 'Validar';
    }
  });

  // Confirmar toma (permite excedente) + loading
  confirmarBtn.onclick = () => {
    const it = LIST[idx]; if (!it) return;
    const key = keyOf(it);
    const restanteAntes = restos[key];

    const cantBobina = Number(validarBtn.dataset.cantBobina || 0);
    const q = Number(takeQty.value);
    if (isNaN(q) || q < 0) { takeStatus.innerHTML = '<span class="err">Cantidad inválida.</span>'; return; }
    if (q > cantBobina) { takeStatus.innerHTML = '<span class="err">No podés tomar más de lo que tiene la bobina.</span>'; return; }

    confirmarBtn.disabled = true;
    confirmarBtn.dataset.label = confirmarBtn.textContent;
    confirmarBtn.textContent = 'Registrando…';

    // Permitir excedente (restante puede ir negativo)
    restos[key] = (restanteAntes - q);

    const ahora = restos[key];
    if (ahora > 0)      takeStatus.innerHTML = `<span class="ok">Registrado. Restante del SKU: ${ahora}.</span>`;
    else if (ahora === 0) takeStatus.innerHTML = `<span class="ok">Registrado. SKU completo.</span>`;
    else                takeStatus.innerHTML = `<span class="ok">Registrado. Excedente entregado: ${Math.abs(ahora)}.</span>`;

    renderItem();

    confirmarBtn.disabled = false;
    confirmarBtn.textContent = confirmarBtn.dataset.label || 'Confirmar';
  };

  cancelBtn.onclick = () => { takeWrap.style.display = 'none'; takeStatus.textContent = ''; };

  // Navegación
  nextBtn.addEventListener('click', () => { if (idx < LIST.length - 1) { idx++; renderItem(); } });
  prevBtn.addEventListener('click', () => { if (idx > 0) { idx--; renderItem(); } });

  // Saltar: manda el pendiente al final
  skipBtn.addEventListener('click', () => {
    if (!LIST.length) return;
    const it = LIST[idx];
    const key = keyOf(it);
    if (restos[key] > 0) {
      LIST.push(it);
      LIST.splice(idx, 1);
      if (idx >= LIST.length) idx = LIST.length - 1;
    } else if (idx < LIST.length - 1) {
      idx++;
    }
    renderItem();
  });

  // Cámara (toggle) usando html5-qrcode
  let qrScanner = null;
  camBtn.addEventListener('click', () => {
    if (cameraWrap.style.display === 'none') {
      cameraWrap.style.display = 'block';
      startQr();
    } else {
      stopQr();
      cameraWrap.style.display = 'none';
    }
  });

  function startQr() {
    try {
      if (qrScanner) return;
      const config = { fps: 10, qrbox: 240, aspectRatio: 1.777 };
      qrScanner = new Html5QrcodeScanner('qr-reader', config, false);
      const onScanSuccess = (decodedText) => {
        scanInp.value = decodedText;
        stopQr();
        cameraWrap.style.display = 'none';
        validarBtn.click();
      };
      const onScanError = (_msg) => {};
      qrScanner.render(onScanSuccess, onScanError);
      camBtn.textContent = 'Cerrar cámara';
    } catch (e) {
      scanStatus.innerHTML = `<span class="err">No se pudo iniciar la cámara: ${e?.message || ''}</span>`;
    }
  }
  function stopQr() {
    if (qrScanner) { try { qrScanner.clear(); } catch {} qrScanner = null; }
    const qrDiv = document.getElementById('qr-reader');
    if (qrDiv) qrDiv.innerHTML = '';
    camBtn.textContent = 'Usar cámara';
  }

  // Init
  (async function init(){
    statusEl.textContent = 'Listo para cargar.';
    await loadLines();
  })();
</script>
</body>
</html>

