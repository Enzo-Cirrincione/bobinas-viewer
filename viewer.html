<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bobina</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:16px; }
    .wrap { max-width:760px; margin:0 auto; }
    .card { display:grid; gap:8px; padding:16px; border:1px solid #e5e7eb; border-radius:12px; }
    .title { font-size:24px; font-weight:700; margin:0 0 12px; }
    .muted { color:#6b7280; }
    .error { color:#b91c1c; }
    .row b { display:inline-block; min-width:190px; }
    a { color:#2563eb; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Ficha de bobina</h1>
    <div id="status" class="muted">Cargando…</div>
    <div id="card" class="card" style="display:none"></div>
  </div>

  <script>
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    async function main() {
      const id = getQueryParam('id');
      const statusEl = document.getElementById('status');
      const cardEl = document.getElementById('card');
      if (!id) { statusEl.textContent = "Falta parámetro 'id'"; return; }
      try {
        statusEl.textContent = 'Consultando…';
        const r = await fetch(`/api/bobina/${encodeURIComponent(id)}`);
        const txt = await r.text();
        let data; try { data = JSON.parse(txt); } catch { data = { error:'parse_error', raw:txt }; }
        if (!r.ok || data.error) { statusEl.innerHTML = `<span class="error">Error: ${data.message || data.error || r.status}</span>`; return; }
        statusEl.style.display = 'none';
        cardEl.style.display = 'grid';

        const get = (k, alts=[]) => {
          if (data[k] != null && data[k] !== '') return data[k];
          for (const a of alts) if (data[a] != null && data[a] !== '') return data[a];
          return '';
        };

        const rows = [
          ['ID_FILA', get('ID_FILA')],
          ['CÓDIGO', get('CODIGO', ['CÓDIGO'])],
          ['DESCRIPCIÓN', get('DESCRIPCION', ['DESCRIPCIÓN'])],
          ['CANTIDAD', get('CANTIDAD')],
          ['PROVEEDOR', get('PROVEEDOR')],
          ['FECHA INGRESO', get('FECHA_INGRESO', ['FECHA INGRESO']) || '—'],
          ['LOTE', get('LOTE')],
          ['FECHA DEVOLUCIÓN', get('FECHA_DEVOLUCION', ['FECHA DEVOLUCIÓN']) || '—'],
          ['LÍNEA', get('ULTIMA_LINEA', ['LINEA'])],
          ['UBICACIÓN', get('UBICACION_ALMACEN', ['UBICACIÓN'])],
          ['ESTADO', get('ESTADO')],
          ['OBSERVACIÓN', get('OBSERVACION', ['OBSERVACIÓN'])]
        ];

        cardEl.innerHTML = rows.map(([k, v]) => `<div class="row"><b>${k}:</b> ${v || ''}</div>`).join('');
        // 1) Leer la URL de imagen desde el JSON
       const img = get('IMAGEN_URL');

        // 2) Si existe, generamos el bloque visual
        if (img) {
          // 2.a) Creamos un <div> para mantener el mismo estilo de fila
          const div = document.createElement('div');
          div.className = 'row';

          // 2.b) Definimos el contenido del <div>: etiqueta + <img>
          div.innerHTML = `
         <b>Imagen:</b><br>
         <img
           src="${img}"
           alt="Etiqueta"
           style="
             max-width:100%;
             max-height:320px;
             object-fit:contain;
             border:1px solid #e5e7eb;
             border-radius:8px;
            "
           loading="lazy"
           referrerpolicy="no-referrer"
        />
        `;

        // 2.c) Lo insertamos en la tarjeta
        cardEl.appendChild(div);
      }


        const url = get('URL');
        if (url) {
          const div = document.createElement('div');
          div.className = 'row';
          div.innerHTML = `<b>Ficha/Imagen:</b> <a href="${url}" target="_blank" rel="noreferrer">Abrir</a>`;
          cardEl.appendChild(div);
        }
      } catch (e) {
        statusEl.innerHTML = `<span class="error">${(e && e.message) ? e.message : 'Error inesperado'}</span>`;
      }
    }
  <div id="devolucion" class="card" style="margin-top:16px; display:none">
  <div style="font-weight:700">CARGAR DEVOLUCIÓN</div>
  <form id="devForm">
    <div class="row"><b>CANTIDAD DEVUELTA:</b> <input type="number" min="0" step="1" name="cantidad_devolucion" required></div>
    <div class="row"><b>LÍNEA:</b> <input type="text" name="linea" placeholder="Ej. L3"></div>
    <div class="row"><b>OBSERVACIÓN:</b> <input type="text" name="observacion" placeholder="Motivo / nota"></div>
    <div class="row"><b>USUARIO:</b> <input type="text" name="usuario" placeholder="(opcional)"></div>
    <button type="submit">Enviar devolución</button>
    <span id="devStatus" class="muted"></span>
  </form>
  </div>

    main(
      const dev = document.getElementById('devolucion');
const devForm = document.getElementById('devForm');
const devStatus = document.getElementById('devStatus');
dev.style.display = 'grid';

devForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  devStatus.textContent = 'Enviando…';

  const payload = {
    id,
    cantidad_devolucion: Number(devForm.cantidad_devolucion.value),
    linea: devForm.linea.value || undefined,
    observacion: devForm.observacion.value || undefined,
    usuario: devForm.usuario.value || undefined
  };
  Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

  try {
    const r = await fetch('/api/bobina/devolucion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const txt = await r.text();
    let out; try { out = JSON.parse(txt); } catch { out = { raw: txt }; }
    if (!r.ok || out.error) {
      devStatus.innerHTML = `<span class="error">Error: ${out.message || out.error || r.status}</span>`;
      return;
    }
    devStatus.textContent = 'OK. Devolución cargada.';
    setTimeout(() => window.location.reload(), 800);
  } catch (e) {
    devStatus.innerHTML = `<span class="error">${e?.message || 'Error inesperado'}</span>`;
  }
});

    );
  </script>
</body>
</html>
